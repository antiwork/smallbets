<% @page_title = "Stats V2" %>
<% @body_class = "sidebar stats-page" %>

<% content_for :head do %>
  <%= stylesheet_link_tag "application/stats" %>
<% end %>

<% content_for :nav do %>
  <%= account_logo_tag if Current.account.logo.attached? %>
  <%= tag.span class: "btn btn--reversed btn--faux room--current" do %>
    <h1 class="room__contents txt-medium overflow-ellipsis">Message Stats (V2)</h1>
  <% end %>
  <%= link_back %>
  <%= link_to stats_v2_dashboard_path, class: "btn d-hotwire-native-none" do %>
    <%= image_tag("refresh.svg", aria: { hidden: "true" }, size: 20) %>
    <span class="for-screen-reader">Refresh stats</span>
  <% end %>
<% end %>

<% content_for :sidebar, sidebar_turbo_frame_tag(src: user_sidebar_path) %>

<section class="full-width">
  <div class="alert alert-info" style="margin: 1rem 0;">
    <strong>Stats V2 (Beta)</strong> - You're viewing the new stats implementation.
    <%= link_to "Switch to V1", stats_path %>
  </div>

  <h2 class="section-heading">Top Talkers</h2>
  <div class="stats-grid margin-block">
    <% Stats::V2::BaseController::PERIODS.each do |period| %>
      <%
        users = instance_variable_get("@top_posters_#{period}")
        current_user_rank = instance_variable_get("@current_user_#{period}_rank")
      %>
      <%= render 'stats/v2/shared/stat_card', title: period_title(period), link: stats_v2_talker_path(period: period) do %>
        <%= render 'stats/v2/shared/leaderboard_table', users: users, current_user_rank: current_user_rank %>
      <% end %>
    <% end %>
  </div>

  <h2 class="section-heading" style="margin-top: 2rem;">Stats</h2>
  <div class="stats-grid margin-block">
    <%= render 'stats/v2/dashboard/top_rooms', top_rooms: @top_rooms %>
    <%= render 'stats/v2/dashboard/message_history', recent_message_history: @recent_message_history, all_time_message_history: @all_time_message_history %>
    <%= render 'stats/v2/dashboard/system_info', system_metrics: @system_metrics %>
  </div>
</section>
