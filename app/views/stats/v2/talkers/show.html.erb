<% @page_title = "#{period_title(@period)} - Top Talkers" %>
<% @body_class = "sidebar stats-page" %>

<% content_for :head do %>
  <%= stylesheet_link_tag "application/stats" %>
<% end %>

<% content_for :nav do %>
  <%= account_logo_tag if Current.account.logo.attached? %>
  <%= tag.span class: "btn btn--reversed btn--faux room--current" do %>
    <h1 class="room__contents txt-medium overflow-ellipsis"><%= period_title(@period) %> - Top Talkers</h1>
  <% end %>
  <%= link_to stats_v2_dashboard_path, class: "btn" do %>
    <%= image_tag("arrow-left.svg", aria: { hidden: "true" }, size: 20) %>
    <span>Back to Stats</span>
  <% end %>
  <%= link_to stats_v2_talker_path(period: @period), class: "btn d-hotwire-native-none" do %>
    <%= image_tag("refresh.svg", aria: { hidden: "true" }, size: 20) %>
    <span class="for-screen-reader">Refresh stats</span>
  <% end %>
<% end %>

<% content_for :sidebar, sidebar_turbo_frame_tag(src: user_sidebar_path) %>

<% from_path = stats_v2_talker_path(period: @period) %>

<section class="full-width">
  <% if @period == :all_time %>
    <div class="margin-block">
      <div class="card">
        <div class="card-header">
          <h2 class="txt-h3 margin-none"><%= period_title(@period) %></h2>
        </div>
        <div class="card-body compact">
          <% if @current_user_rank && @current_user_rank > 100 %>
            <div style="padding: 1rem; background: var(--color-bg-subtle); border-radius: 4px; margin-bottom: 1rem;">
              <strong>Your rank:</strong> #<%= @current_user_rank %>
            </div>
          <% end %>

          <div class="overflow-x-auto">
            <table class="table full-width">
              <tbody>
                <% if @users.any? %>
                  <% @users.each_with_index do |user, index| %>
                    <%= render "stats/v2/shared/user_row", user: user, rank: index + 1, from_path: from_path %>
                  <% end %>
                <% else %>
                  <tr>
                    <td colspan="3" class="txt-center">No messages yet</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  <% elsif @period == :month %>
    <% @sorted_years.each do |year| %>
      <h2 class="section-heading"><%= year %></h2>
      <div class="stats-grid margin-block" style="margin-bottom: 2rem;">
        <% @months_by_year[year].sort.reverse.each do |month| %>
          <% year_num, month_num = month.split('-') %>
          <% month_name = Date.new(year_num.to_i, month_num.to_i, 1).strftime("%B %Y") %>
          <div class="card grid-card">
            <div class="card-header">
              <h2 class="txt-h3 margin-none"><%= month_name %></h2>
            </div>
            <div class="card-body compact">
              <div class="overflow-x-auto">
                <table class="table full-width">
                  <tbody>
                    <% if @monthly_stats[month].present? %>
                      <% @monthly_stats[month].each_with_index do |user, index| %>
                        <%= render "stats/v2/shared/user_row", user: user, rank: index + 1, from_path: from_path %>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="3" class="txt-center">No messages yet</td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

  <% elsif @period == :year %>
    <div class="stats-grid margin-block">
      <% @years.each do |year| %>
        <div class="card grid-card">
          <div class="card-header">
            <h2 class="txt-h3 margin-none"><%= year %></h2>
          </div>
          <div class="card-body compact">
            <div class="overflow-x-auto">
              <table class="table full-width">
                <tbody>
                  <% if @yearly_stats[year].present? %>
                    <% @yearly_stats[year].each_with_index do |user, index| %>
                      <%= render "stats/v2/shared/user_row", user: user, rank: index + 1, from_path: from_path %>
                    <% end %>
                  <% else %>
                    <tr>
                      <td colspan="3" class="txt-center">No messages yet</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% end %>
    </div>

  <% elsif @period == :today %>
    <% @sorted_months.each do |month_key| %>
      <% year_num, month_num = month_key.split('-') %>
      <% month_name = Date.new(year_num.to_i, month_num.to_i, 1).strftime("%B %Y") %>
      <h2 class="section-heading"><%= month_name %></h2>
      <div class="stats-grid margin-block" style="margin-bottom: 2rem;">
        <% @days_by_month[month_key].sort.reverse.each do |day| %>
          <% day_label = Date.parse(day).strftime("%A, %B %-d, %Y") %>
          <div class="card grid-card">
            <div class="card-header">
              <h2 class="txt-h3 margin-none"><%= day_label %></h2>
            </div>
            <div class="card-body compact">
              <div class="overflow-x-auto">
                <table class="table full-width">
                  <tbody>
                    <% if @daily_stats[day].present? %>
                      <% @daily_stats[day].each_with_index do |user, index| %>
                        <%= render "stats/v2/shared/user_row", user: user, rank: index + 1, from_path: from_path %>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="3" class="txt-center">No messages yet</td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>
</section>
